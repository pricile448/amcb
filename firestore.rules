// firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ‘®â€â™‚ï¸ Collection admins : Administrateurs de la plateforme
    match /admins/{adminId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == adminId;
      allow update: if request.auth != null && request.auth.uid == adminId;
      allow delete: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin';
      allow read: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role in ['admin', 'super_admin'];
    }
    
    // ğŸ‘¤ Collection users : RÃˆGLES SIMPLIFIÃ‰ES POUR KYC
    match /users/{userId} {
      // âœ… CRÃ‰ATION : utilisateur peut crÃ©er son propre document
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // âœ… LECTURE : utilisateur peut lire ses propres donnÃ©es
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // âœ… MISE Ã€ JOUR : utilisateur peut mettre Ã  jour ses propres donnÃ©es
      // ğŸ”§ SIMPLIFICATION : Permettre toutes les mises Ã  jour pour l'utilisateur
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ§¾ Collection kycSubmissions : RÃˆGLES SIMPLIFIÃ‰ES
    match /kycSubmissions/{submissionId} {
      // âœ… CRÃ‰ATION : utilisateur peut crÃ©er ses propres soumissions
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // âœ… LECTURE : utilisateur peut lire ses propres soumissions
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // âœ… MISE Ã€ JOUR : utilisateur peut mettre Ã  jour ses propres soumissions
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // âœ… SUPPRESSION : utilisateur peut supprimer ses propres soumissions
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ¦ Collection accounts
    match /accounts/{accountId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ’° Collection transactions
    match /transactions/{transactionId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ“„ Collection documents
    match /documents/{documentId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ”„ Collection transfers
    match /transfers/{transferId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ‘¥ Collection beneficiaries
    match /beneficiaries/{beneficiaryId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ’¬ Collection chats
    match /chats/{chatId} {
      allow read: if request.auth != null 
        && (resource.data.userId == request.auth.uid || request.auth.uid in resource.data.participants);
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      
      match /messages/{messageId} {
        allow read: if request.auth != null 
          && (get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid
              || request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        allow create: if request.auth != null 
          && (get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid
              || request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants)
          && request.resource.data.senderId == request.auth.uid;
        allow read, write: if request.auth != null 
          && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
    }
    
    // ğŸ“§ Collection emailVerificationCodes
    match /emailVerificationCodes/{userId} {
      allow create, read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ¦ Collection ribRequests : Demandes de RIB
    match /ribRequests/{requestId} {
      // âœ… CRÃ‰ATION : utilisateur peut crÃ©er ses propres demandes
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // âœ… LECTURE : utilisateur peut lire ses propres demandes
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // âœ… MISE Ã€ JOUR : utilisateur peut mettre Ã  jour ses propres demandes
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ’³ Collection cardRequests : Demandes de cartes
    match /cardRequests/{requestId} {
      // âœ… CRÃ‰ATION : utilisateur peut crÃ©er ses propres demandes
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // âœ… LECTURE : utilisateur peut lire ses propres demandes
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // âœ… MISE Ã€ JOUR : utilisateur peut mettre Ã  jour ses propres demandes
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // âœ… NOTE: Les sous-documents RIB et cartes sont stockÃ©s dans users/{userId}
    // Les rÃ¨gles users existantes couvrent dÃ©jÃ  l'accÃ¨s aux donnÃ©es
    
    // ğŸš« Tout le reste est refusÃ© par dÃ©faut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}