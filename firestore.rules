// firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ‘¤ Collection users : Lecture/Ã©criture pour le propriÃ©taire
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // âœ… Permettre la mise Ã  jour du kycStatus : unverified â†’ pending
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && request.auth.uid == resource.data.uid
        && (
          // Utilisateur peut passer de unverified Ã  pending
          (resource.data.kycStatus == 'unverified' && request.resource.data.kycStatus == 'pending')
          // Ou garder le mÃªme statut (pour autres champs)
          || (resource.data.kycStatus == request.resource.data.kycStatus)
          // Ou mise Ã  jour avec kycStatusDetails (nouveau format)
          || (request.resource.data.keys().hasAny(['kycStatus', 'kycStatusDetails', 'updatedAt']))
        );
      
      // ğŸ”” RÃ¨gles spÃ©cifiques pour les notifications dans le document utilisateur
      // Permettre la lecture/Ã©criture/modification du champ notifications
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && (
          // Permettre la modification du champ notifications
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['notifications', 'updatedAt']))
          // Ou d'autres champs autorisÃ©s
          || (request.resource.data.diff(resource.data).affectedKeys().hasAny(['kycStatus', 'verificationStatus', 'lastSignInTime', 'emailVerified', 'isEmailVerified']))
        );
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout lire/modifier
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ§¾ Collection kycSubmissions
    match /kycSubmissions/{submissionId} {
      // âœ… Permettre la crÃ©ation avec tous les champs nÃ©cessaires
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Utilisateur peut lire ses propres soumissions
      allow read: if request.auth != null 
        && request.auth.uid == resource.data.userId;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ¦ Collection accounts : Comptes bancaires
    match /accounts/{accountId} {
      // Utilisateur peut lire ses propres comptes
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Utilisateur peut crÃ©er/modifier ses propres comptes
      allow create, update: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ’° Collection transactions : Transactions bancaires
    match /transactions/{transactionId} {
      // Utilisateur peut lire ses propres transactions
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Utilisateur peut crÃ©er ses propres transactions
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ“„ Collection documents : Documents utilisateur
    match /documents/{documentId} {
      // Utilisateur peut lire ses propres documents
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Utilisateur peut crÃ©er/modifier/supprimer ses propres documents
      allow create, update, delete: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ”„ Collection transfers : Virements
    match /transfers/{transferId} {
      // Utilisateur peut lire ses propres virements
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Utilisateur peut crÃ©er ses propres virements
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ‘¥ Collection beneficiaries : BÃ©nÃ©ficiaires
    match /beneficiaries/{beneficiaryId} {
      // Utilisateur peut lire ses propres bÃ©nÃ©ficiaires
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Utilisateur peut crÃ©er ses propres bÃ©nÃ©ficiaires
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Utilisateur peut modifier ses propres bÃ©nÃ©ficiaires
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      // Utilisateur peut supprimer ses propres bÃ©nÃ©ficiaires
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸ’¬ Collection chats : Messages de support
    match /chats/{chatId} {
      // Utilisateur peut lire ses propres chats (oÃ¹ il est participant)
      allow read: if request.auth != null 
        && (
          // Soit il est le crÃ©ateur du chat
          resource.data.userId == request.auth.uid
          // Soit il est dans la liste des participants
          || request.auth.uid in resource.data.participants
        );
      
      // Utilisateur peut crÃ©er ses propres chats
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // ğŸ’¬ Sous-collection messages : Messages dans chaque chat
      match /messages/{messageId} {
        // Utilisateur peut lire les messages des chats oÃ¹ il est participant
        allow read: if request.auth != null 
          && (
            // Soit il est le crÃ©ateur du chat parent
            get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid
            // Soit il est dans la liste des participants du chat parent
            || request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          );
        
        // Utilisateur peut crÃ©er des messages dans les chats oÃ¹ il est participant
        allow create: if request.auth != null 
          && (
            // Soit il est le crÃ©ateur du chat parent
            get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid
            // Soit il est dans la liste des participants du chat parent
            || request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          )
          && request.resource.data.senderId == request.auth.uid;
        
        // Admins peuvent tout faire
        allow read, write: if request.auth != null 
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
    }
    
    // ğŸ“§ Collection emailVerificationCodes : Codes de vÃ©rification email
    match /emailVerificationCodes/{userId} {
      // Utilisateur peut crÃ©er/lire/modifier/supprimer ses propres codes
      allow create, read, update, delete: if request.auth != null 
        && request.auth.uid == userId;
      
      // Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ğŸš« Tout le reste est refusÃ© par dÃ©faut
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 