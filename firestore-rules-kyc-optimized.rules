rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ‘®â€â™‚ï¸ Collection admins : Administrateurs de la plateforme
    match /admins/{adminId} {
      // âœ… CrÃ©ation : Seuls les utilisateurs authentifiÃ©s peuvent crÃ©er des admins
      allow create: if request.auth != null;
      
      // âœ… Lecture : L'admin peut lire ses propres donnÃ©es
      allow read: if request.auth != null 
        && request.auth.uid == adminId;
      
      // âœ… Mise Ã  jour : L'admin peut mettre Ã  jour ses propres donnÃ©es
      allow update: if request.auth != null 
        && request.auth.uid == adminId;
      
      // âœ… Suppression : Seuls les super admins peuvent supprimer des admins
      allow delete: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin';
      
      // ğŸ” Lecture par email : Pour la vÃ©rification des droits admin
      allow read: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role in ['admin', 'super_admin'];
    }
    
    // ğŸ‘¤ Collection users : RÃ¨gles KYC optimisÃ©es et CORRIGÃ‰ES
    match /users/{userId} {
      // âœ… CRÃ‰ATION : utilisateur peut crÃ©er son propre document
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // âœ… LECTURE : utilisateur peut TOUJOURS lire ses propres donnÃ©es
      // ğŸ”§ CORRECTION : Suppression des restrictions bloquantes
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // âœ… MISE Ã€ JOUR : RÃ¨gles KYC strictes
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && (
          // ğŸ” TRANSITIONS KYC AUTORISÃ‰ES POUR L'UTILISATEUR
          (
            // 1. unverified â†’ pending (soumission de documents)
            (resource.data.kycStatus == 'unverified' && request.resource.data.kycStatus == 'pending')
            ||
            // 2. pending â†’ pending (mise Ã  jour des documents)
            (resource.data.kycStatus == 'pending' && request.resource.data.kycStatus == 'pending')
          )
          ||
          // ğŸ“ CHAMPS AUTORISÃ‰S POUR TOUS LES STATUTS
          request.resource.data.diff(resource.data).affectedKeys().hasAny([
            'kycStatusDetails', 'verificationStatus', 
            'notifications', 'lastSignInTime', 'emailVerified', 
            'isEmailVerified', 'updatedAt', 'defaultAccountsCreated', 'defaultAccountsCreatedAt',
            'billingBic', 'billingHolder', 'billingIban', 'billingText', 'billingVisible',
            'emailVerificationCode', 'emailVerificationCodeExpires', 'emailVerifiedAt',
            'phoneVerified', 'isPhoneVerified', 'validatedAt', 'verifiedAt',
            'address', 'phone', 'birthDate', 'birthPlace', 'nationality', 'profession', 'salary'
          ])
          ||
          // ğŸ”’ CHAMPS SENSIBLES SEULEMENT SI VERIFIED
          (
            resource.data.kycStatus == 'verified' &&
            request.resource.data.diff(resource.data).affectedKeys().hasAny([
              'accounts', 'beneficiaries', 'budgets', 'cardLimits', 'documents', 'transactions', 'virtualCards'
            ])
          )
        )
        &&
        // ğŸš« PROTECTION CONTRE LES TRANSITIONS RÃ‰TROGRADES
        (
          // Bloquer verified â†’ unverified
          !(resource.data.kycStatus == 'verified' && request.resource.data.kycStatus == 'unverified')
          &&
          // Bloquer verified â†’ pending
          !(resource.data.kycStatus == 'verified' && request.resource.data.kycStatus == 'pending')
          &&
          // Bloquer rejected â†’ verified (seul admin peut)
          !(resource.data.kycStatus == 'rejected' && request.resource.data.kycStatus == 'verified')
        );
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire (y compris changer kycStatus)
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ†• RÃˆGLE SPÃ‰CIALE POUR LES DONNÃ‰ES DE FACTURATION
    // Permet aux admins de gÃ©rer les donnÃ©es de facturation de tous les utilisateurs
    match /users/{userId}/billing/{document=**} {
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ§¾ Collection kycSubmissions
    match /kycSubmissions/{submissionId} {
      // âœ… CrÃ©ation : utilisateur peut crÃ©er ses propres soumissions
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['id', 'userId', 'documentType', 'cloudinaryUrl', 'cloudinaryPublicId', 'fileName', 'fileSize', 'mimeType', 'submittedAt']);
      
      // âœ… Lecture : utilisateur peut lire ses propres soumissions
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // âœ… Mise Ã  jour : utilisateur peut mettre Ã  jour ses propres soumissions
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // âœ… Suppression : utilisateur peut supprimer ses propres soumissions
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
         // ğŸ¦ Collection accounts : Comptes bancaires - ACCÃˆS AUTORISÃ‰ POUR TOUS LES STATUTS KYC
     match /accounts/{accountId} {
       allow read: if request.auth != null 
         && resource.data.userId == request.auth.uid;
       
       allow create, update: if request.auth != null 
         && request.resource.data.userId == request.auth.uid;
       
       allow read, write: if request.auth != null 
         && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
     }
    
         // ğŸ’° Collection transactions : Transactions bancaires - ACCÃˆS AUTORISÃ‰ POUR TOUS LES STATUTS KYC
     match /transactions/{transactionId} {
       // âœ… Lecture : utilisateur peut lire ses propres transactions
       allow read: if request.auth != null 
         && resource.data.userId == request.auth.uid;
       
       // âœ… CrÃ©ation : avec validation des champs obligatoires
       allow create: if request.auth != null 
         && request.resource.data.userId == request.auth.uid
         && request.resource.data.keys().hasAll([
           'date', 'description', 'account', 'category', 'reference', 'amount', 'userId'
         ])
         && request.resource.data.amount is number
         && request.resource.data.date is timestamp
         && request.resource.data.description is string
         && request.resource.data.account is string
         && request.resource.data.category is string
         && request.resource.data.reference is string;
       
       // âœ… Mise Ã  jour : utilisateur peut modifier ses propres transactions
       allow update: if request.auth != null 
         && resource.data.userId == request.auth.uid
         && request.resource.data.userId == request.auth.uid;
       
       // âœ… Suppression : utilisateur peut supprimer ses propres transactions
       allow delete: if request.auth != null 
         && resource.data.userId == request.auth.uid;
       
       // ğŸ‘®â€â™‚ï¸ Admins peuvent tout faire
       allow read, write: if request.auth != null 
         && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
     }
    
    // ğŸ“„ Collection documents : Documents utilisateur
    match /documents/{documentId} {
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      allow create, update, delete: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ”„ Collection transfers : Virements
    match /transfers/{transferId} {
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ‘¥ Collection beneficiaries : BÃ©nÃ©ficiaires
    match /beneficiaries/{beneficiaryId} {
      allow read: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸ’¬ Collection chats : Messages de support
    match /chats/{chatId} {
      allow read: if request.auth != null 
        && (
          resource.data.userId == request.auth.uid
          || request.auth.uid in resource.data.participants
        );
      
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      
      // ğŸ’¬ Sous-collection messages
      match /messages/{messageId} {
        allow read: if request.auth != null 
          && (
            get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid
            || request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          );
        
        allow create: if request.auth != null 
          && (
            get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid
            || request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          )
          && request.resource.data.senderId == request.auth.uid;
        
        allow read, write: if request.auth != null 
          && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
    }
    
    // ğŸ“§ Collection emailVerificationCodes : Codes de vÃ©rification email
    match /emailVerificationCodes/{userId} {
      allow create, read, update, delete: if request.auth != null 
        && request.auth.uid == userId;
      
      allow read, write: if request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ğŸš« Tout le reste est refusÃ© par dÃ©faut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
